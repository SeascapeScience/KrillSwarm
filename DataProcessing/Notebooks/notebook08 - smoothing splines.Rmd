title: "Notebook08 - smoothing splines"
output: html_notebook
---

```{r}
rm(list=ls(all=TRUE))
load("C:\\Users\\Nicole Hellessey\\Documents\\Post-doc\\Data\\Total Merged Data File (July 12 2022).Rdata")
```

Remove ends of tank and clean data

```{r}
#### cut 1cm from each axis to get rid of edge effect
#### gives us only what's happening in center of tank 
### gives us defined segments to spline

## start by getting rid of front and back of tank 

hist(CC.TotalData$X)

#####################################################

range(CC.TotalData$X)
range(CC.TotalData$Y)
range(CC.TotalData$Z)

CC.TotalData$X[which(CC.TotalData$X < 0)] = CC.TotalData$X*(-1)

hist(CC.TotalData$X)

```
```{r}

CC.TotalData$xsmooth <- runmed(x = CC.TotalData$X, k = 31, na.action = 'na.omit')  ## optimum number for smoothing (try 31 to 101)
plot(CC.TotalData$X[1000:10000])
plot(CC.TotalData$xsmooth[1000:10000])

CC.TotalData$ysmooth <- runmed(x = CC.TotalData$Y, k = 31, na.action = 'na.omit')
plot(CC.TotalData$Y[1000:10000])
plot(CC.TotalData$ysmooth[1000:10000])


CC.TotalData$zsmooth <- runmed(x = CC.TotalData$Z, k = 31, na.action = 'na.omit')
plot(CC.TotalData$Z[1000:10000])
plot(CC.TotalData$zsmooth[1000:10000])


```

```{r}
rm(alldata, df, TotalData, D, d1, d2, dd, dotprod, dotx, doty, dotz, dx1, dx2, dy1, dy2, dz1, dz2, list2, list3, list4, list5, v1, v2, vx1, vx2, vy1, vy2, vz1, vz2, x1, x2, y1, y2, z1, z2)
rm(lth, l, ind, i, files)
rm(metadata, ldf)
save.image("~/Post-doc/Data/Total Merged Data File (July 12 2022).RData")
```



```{r}
x1 <- CC.TotalData$X[1:(nrow(CC.TotalData)-1)]
x2 <- CC.TotalData$X[2:nrow(CC.TotalData)]
CC.TotalData$dx[1:(nrow(CC.TotalData)-1)] <- x2-x1

y1 <- CC.TotalData$Y[1:(nrow(CC.TotalData)-1)]
y2 <- CC.TotalData$Y[2:nrow(CC.TotalData)]
CC.TotalData$dy[1:(nrow(CC.TotalData)-1)] <- y2-y1

z1 <- CC.TotalData$Z[1:(nrow(CC.TotalData)-1)]
z2 <- CC.TotalData$Z[2:nrow(CC.TotalData)]
CC.TotalData$dz[1:(nrow(CC.TotalData)-1)] <- z2-z1

CC.TotalData$d <- sqrt(CC.TotalData$dx^2 + CC.TotalData$dy^2 + CC.TotalData$dz^2)

head(CC.TotalData)
tail(CC.TotalData)
```



```{r}
CC.TotalData$vx <- CC.TotalData$dx/(1/30)  ## velocity on the x axis
CC.TotalData$vy <- CC.TotalData$dy/(1/30)  ## velocity on the y axis
CC.TotalData$vz <- CC.TotalData$dz/(1/30)  ## velocity on the z axis
CC.TotalData$v <- CC.TotalData$d/(1/30) ## total velocity

CC.TotalData$heading <- atan2(CC.TotalData$dx, CC.TotalData$dy)
CC.TotalData$heading.pi <- CC.TotalData$heading/(2*pi)*360
CC.TotalData$pitch <- atan2(CC.TotalData$dz, (sqrt(CC.TotalData$dx^2 + CC.TotalData$dy^2)))
CC.TotalData$pitch.perfect <- CC.TotalData$pitch/(2*pi)*360


hist(CC.TotalData$pitch/(2*pi)*360)
hist(CC.TotalData$heading/(2*pi)*360)

hist(CC.TotalData$dz[abs(CC.TotalData$dz)<.01],breaks = 100)
hist(CC.TotalData$dy[abs(CC.TotalData$dy)<.01],breaks = 100)
hist(CC.TotalData$dx[abs(CC.TotalData$dx)<.01],breaks = 100)

```

```{r}
CC.TotalData$turn.anglexy <- atan2(CC.TotalData$X, CC.TotalData$Y)
CC.TotalData$turn.angleyz <- atan2(CC.TotalData$Y, CC.TotalData$Z)


lth <- dim(CC.TotalData)[1]
dx1 <- CC.TotalData$dx[1:(lth-1)]
dx2 <- CC.TotalData$dx[2:lth]
dy1 <- CC.TotalData$dy[1:(lth-1)]
dy2 <- CC.TotalData$dy[2:lth]
dz1 <- CC.TotalData$dz[1:(lth-1)]
dz2 <- CC.TotalData$dz[2:lth]
D <- (dx1*dx2)+(dy1*dy2)+(dz1*dz2)
d1 <- sqrt(dx1^2 + dy1^2 +dz1^2)
d2 <- sqrt(dx2^2 + dy2^2 +dz2^2)

dd <- D/d1/d2
hist(acos(dd)/pi*180)

CC.TotalData$turn.angle <- c(NA, acos(D/d1/d2))/pi*180


```


```{r}

lth <- dim(CC.TotalData)[1]

vx1 <- CC.TotalData$vx[1:(lth-1)]
vy1 <- CC.TotalData$vy[1:(lth-1)]
vz1 <- CC.TotalData$vz[1:(lth-1)]


vx2 <- CC.TotalData$vx[2:lth]
vy2 <- CC.TotalData$vy[2:lth]
vz2 <- CC.TotalData$vz[2:lth]

v1 <- sqrt((vx1^2)+(vy1^2)+(vz1^2))  ##velocity magnitude (one time step above)

v2 <- sqrt((vx2^2)+(vy2^2)+(vz2^2))
### velocity magnitude (1 time step below)

dotx <- (vx1*vx2)
doty <- (vy1*vy2)
dotz <- (vz1*vz2)

dotprod <- (dotx + doty + dotz)

dd <- dotprod/(v1*v2)

l <- 0
list2 <- ((acos(dd)/pi)*180)
list3 <- (v1+v2)/2
list4 <- c(l, list2)
list5 <- c(l, list3)
CC.TotalData$vel.turn.angle <- list4

```


```{r}

str(CC.TotalData)
CC.TotalData$Flow.rate <- as.character(CC.TotalData$Flow.rate)
CC.TotalData$Flow.rate <- as.numeric(CC.TotalData$Flow.rate)

head(CC.TotalData) ## all TotalData rows
str(CC.TotalData)
CC.TotalData$vel.flow <- CC.TotalData$Flow.rate+CC.TotalData$vy
CC.TotalData$Flow.rate <- as.factor(CC.TotalData$Flow.rate)
str(CC.TotalData)
```
Don't forget to remake each factor level dataframe (E.g., CHlA0, f0, l0, g0, etc)
It's in Notebook 06

```{r}
rm(D, d1, d2, dd, dotprod, dotx, doty, dotz, dx1, dx2, dy1, dy2, dz1, dz2, list2, list3, list4, list5, v1, v2, vx1, vx2, vy1, vy2, vz1, vz2, x1, x2, y1, y2, z1, z2)
save.image("~/Post-doc/Data/Total Merged Data File (July 12 2022).RData")
```



